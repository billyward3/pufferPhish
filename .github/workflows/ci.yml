name: CI

on:
  push:
    branches: [main, billy-dev]
  pull_request:
    branches: [main]

jobs:
  lint-and-type-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint --if-present
        continue-on-error: true

      - name: Type check TypeScript
        run: npm run type-check --if-present
        continue-on-error: true

      - name: Build all packages
        run: npm run build --if-present

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for known vulnerabilities
        run: npm audit fix --dry-run
        continue-on-error: true

  test-backend:
    name: Test Backend (if tests exist)
    runs-on: ubuntu-latest

    # Only run if packages/api directory exists
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check if API package exists
        id: check_api
        run: |
          if [ -d "packages/api" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run API tests
        if: steps.check_api.outputs.exists == 'true'
        run: npm test --workspace=packages/api --if-present
        continue-on-error: true

  test-extension:
    name: Test Extension (if tests exist)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check if extension package exists
        id: check_ext
        run: |
          if [ -d "packages/extension" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build extension
        if: steps.check_ext.outputs.exists == 'true'
        run: npm run build --workspace=packages/extension --if-present

      - name: Run extension tests
        if: steps.check_ext.outputs.exists == 'true'
        run: npm test --workspace=packages/extension --if-present
        continue-on-error: true

  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for broken links in markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

      - name: Verify all docs exist
        run: |
          echo "Checking documentation structure..."
          test -f docs/README.md || echo "⚠️ Missing docs/README.md"
          test -f docs/01-ml-integration.md || echo "⚠️ Missing ML integration docs"
          test -f docs/02-extension-integration.md || echo "⚠️ Missing extension docs"
          test -f docs/03-backend-implementation.md || echo "⚠️ Missing backend docs"
          test -d docs/security || echo "⚠️ Missing security directory"
          echo "✅ Documentation validation complete"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, security-audit, test-backend, test-extension, validate-docs]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Lint & Type Check: ${{ needs.lint-and-type-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Tests: ${{ needs.test-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Extension Tests: ${{ needs.test-extension.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation: ${{ needs.validate-docs.result }}" >> $GITHUB_STEP_SUMMARY
